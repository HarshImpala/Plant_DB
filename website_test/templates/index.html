{% extends "base.html" %}

{% block title %}Plant Encyclopedia - Home{% endblock %}

{% block content %}
<div class="home-page">
    <section class="hero">
        <h1>Plant Encyclopedia</h1>
        <p>Explore our collection of <span class="stat-count" data-target="{{ plant_count }}">{{ plant_count }}</span> plant species with detailed taxonomic information, distribution data, and more.</p>
        <div class="hero-search">
            <input type="text" id="hero-search" placeholder="Search for a plant..." autocomplete="off">
            <div id="hero-search-results" class="search-results hero-search-results"></div>
        </div>
    </section>

    <section id="recently-viewed-section" class="recently-viewed-section" style="display:none">
        <h2>Recently Viewed</h2>
        <div id="recently-viewed-list" class="recently-viewed-list"></div>
    </section>

    <section class="browse-section">
        <h2>Browse Plants</h2>
        <div class="browse-options">
            <a href="{{ base_url }}/az-index.html" class="browse-card">
                <h3>A-Z Index</h3>
                <p>Browse all plants alphabetically by scientific name</p>
            </a>
            <a href="{{ base_url }}/families.html" class="browse-card">
                <h3>By Family</h3>
                <p>Explore <span class="stat-count" data-target="{{ family_count }}">{{ family_count }}</span> plant families</p>
            </a>
            <a href="{{ base_url }}/genera.html" class="browse-card">
                <h3>By Genus</h3>
                <p>Browse <span class="stat-count" data-target="{{ genus_count }}">{{ genus_count }}</span> genera</p>
            </a>
        </div>
    </section>

    <section class="recent-section">
        <h2>Featured Plants</h2>
        <div class="plant-grid">
            {% for plant in featured_plants %}
            <a href="{{ base_url }}/plant/{{ plant.slug }}.html" class="plant-card">
                <div class="plant-card-image">
                    {% if plant.image_filename %}
                    <img src="{{ base_url }}/static/images/plants/{{ plant.image_filename }}" alt="{{ plant.canonical_name }}" loading="lazy">
                    {% else %}
                    <div class="placeholder-image"></div>
                    {% endif %}
                </div>
                <div class="plant-card-info">
                    <h3>{{ plant.canonical_name }}</h3>
                    {% if plant.common_name %}
                    <p>{{ plant.common_name }}</p>
                    {% endif %}
                    {% if plant.family %}
                    <span class="family-badge">{{ plant.family }}</span>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
// Animated stat count-up
(function() {
    var counters = document.querySelectorAll('.stat-count');
    if (!counters.length || !window.IntersectionObserver) return;
    var observer = new IntersectionObserver(function(entries) {
        entries.forEach(function(entry) {
            if (!entry.isIntersecting) return;
            var el = entry.target;
            var target = parseInt(el.dataset.target, 10);
            var start = performance.now();
            var duration = 1200;
            function update(now) {
                var progress = Math.min((now - start) / duration, 1);
                var ease = 1 - Math.pow(1 - progress, 3);
                el.textContent = Math.round(ease * target).toLocaleString();
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
            observer.unobserve(el);
        });
    }, { threshold: 0.5 });
    counters.forEach(function(c) { observer.observe(c); });
})();
</script>

<script>
// Recently viewed
(function() {
    try {
        const recent = JSON.parse(localStorage.getItem('recentlyViewed') || '[]');
        if (recent.length === 0) return;
        const list = document.getElementById('recently-viewed-list');
        const section = document.getElementById('recently-viewed-section');
        list.innerHTML = recent.map(function(p) {
            return '<a href="./plant/' + p.slug + '.html" class="recently-viewed-item">'
                + '<span class="scientific">' + p.name + '</span>'
                + (p.common_name ? '<span class="common">' + p.common_name + '</span>' : '')
                + '</a>';
        }).join('');
        section.style.display = '';
    } catch(e) {}
})();
</script>

<script>
(function() {
    const input = document.getElementById('hero-search');
    const resultsBox = document.getElementById('hero-search-results');

    function renderHeroResults(results) {
        if (results.length === 0) {
            resultsBox.innerHTML = '<div class="no-results" style="padding:1rem;color:#666;">No plants found</div>';
            return;
        }
        let html = '';
        for (const plant of results) {
            html += `<a href="./plant/${plant.slug}.html">
                <span class="scientific">${plant.canonical_name || plant.scientific_name}</span>
                ${plant.common_name ? `<br><span class="common">${plant.common_name}</span>` : ''}
            </a>`;
        }
        resultsBox.innerHTML = html;
    }

    input.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length < 2) {
            resultsBox.classList.remove('active');
            return;
        }
        if (typeof window.plantSearch === 'function') {
            const results = window.plantSearch(query);
            renderHeroResults(results);
            resultsBox.classList.add('active');
        }
    });

    input.addEventListener('keydown', function(e) {
        const items = resultsBox.querySelectorAll('a');
        const active = resultsBox.querySelector('a:focus');
        let index = Array.from(items).indexOf(active);
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            (index < items.length - 1 ? items[index + 1] : items[0]).focus();
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            index > 0 ? items[index - 1].focus() : input.focus();
        } else if (e.key === 'Escape') {
            resultsBox.classList.remove('active');
        }
    });

    document.addEventListener('click', function(e) {
        if (!input.contains(e.target) && !resultsBox.contains(e.target)) {
            resultsBox.classList.remove('active');
        }
    });
})();
</script>
{% endblock %}
